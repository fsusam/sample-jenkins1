# Docker Registry for eSON project.
docker:
  registry: armdocker.rnd.ericsson.se/proj-eson

ruleset:
  # By invoking ./bob/bob.sh the generated version will be returned.
  - version:

  # Build Java project based on Maven build system.
  # It will execute Maven `verify` lifecycle phase on `bob build`.
  # It uses settings.xml stored in project repository.
  # It will download all dependencies to project root directory.
  - javamvn:
      env:
        - MVN_BUILD_FLAGS: -e -s settings.xml -Duser.home=.
        - MVN_CLEAN_FLAGS: -e -s settings.xml -Duser.home=.
        - MVN_SONAR_FLAGS: -e -s settings.xml -Duser.home=.
      rule:
        test:
          execute: echo "Skip Bob test phase for Maven"
        build:
          execute: mvn ${MVN_BUILD_FLAGS+${MVN_BUILD_FLAGS}} verify jacoco:prepare-agent install jacoco:report pmd:pmd
        sonar:
          execute: mvn ${MVN_SONAR_FLAGS+${MVN_SONAR_FLAGS}} sonar:sonar -Dsonar.analysis.mode=publish

  # Build Docker container for a project.
  # Uses `Dockerfile` provided in the project root.
  # Overrides docker image name.
  - docker:
      env:
        - DOCKER_IMAGE_NAME: ${DOCKER_REGISTRY}/cm-data-loading-service-enm
        #- DOCKERFILE_PREFIX: './' # Needed for latest versions of bob

  # Build Helm chart for a project.
  # `helm-target` directory will be used used as work build directory.
  # Uses chart defined in `charts/` directory.
  # HELM_VALUES overrides variables inside `values.yaml` in chart: update version.
  - helm:
       env:
        - HELM_DESTINATION_FOLDER: 'helm-target'
        - HELM_REPO:  https://arm.epk.ericsson.se/artifactory/proj-eson-cm-data-loading-service-enm-helm
        - HELM_REPO_API_TOKEN: AKCp5aUQb5BsGtp2mFpCvHCXZ6aFKXXm9t3tBqKiarcRY36PSRZJxHYoHBpisLJAv1Tzb62k6
        - HELM_REPO_INDEX: "false"
        - HELM_VALUES: >-
            images:cm-data-loading-service-enm:tag=$(project::get_version ${RELEASE:-})

  # Generate properties for usage later in ADP pipeline.
  - adp.artifacts:
      env:
        - CHART_NAME: cm-data-loading-service-enm
        - CHART_VERSION: $(project::get_version ${RELEASE:-})
        - CHART_REPO: https://arm.epk.ericsson.se/artifactory/proj-eson-cm-data-loading-service-enm-helm
        - IMAGE_NAME: cm-data-loading-service-enm
        - IMAGE_TAG: $(project::get_version ${RELEASE:-})
        - IMAGE_REPO: ${DOCKER_REGISTRY}

# Remove files generated by build process
rule:
  clean:
    execute: |
      rm -f adp-cicd-goals.properties && \
      rm -f artifact.properties && \
      rm -rf helm-target

  # Add two tags to the image to push
  image:
    execute:
     docker tag armdocker.rnd.ericsson.se/proj-eson/cm-data-loading-service-enm:$(project::get_version ${RELEASE:-}) armdocker.rnd.ericsson.se/proj-eson/cm-data-loading-service-enm:latest
